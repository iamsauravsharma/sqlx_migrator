<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Migrator module"><title>sqlx_migrator::migrator - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-2fcac8296ac587d8.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="sqlx_migrator" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0-nightly (a97c36dd2 2023-06-07)" data-search-js="search-4926e5fc22a5646a.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../../static.files/storage-62ce34ea385b278a.js"></script><script defer src="../../static.files/main-48600a9606eff342.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../sqlx_migrator/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../sqlx_migrator/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module migrator</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">sqlx_migrator</a>::<wbr><a class="mod" href="#">migrator</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../src/sqlx_migrator/migrator/mod.rs.html#1-618">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Migrator module</p>
<p>It contains common enum and trait for implementing migrator for sqlx
supported database</p>
<p>It also provides its own struct Migrator which supports Postgres, Sqlite and
Mysql Database only</p>
<h2 id="example"><a href="#example">Example</a></h2>
<p>Create own custom Migrator which only supports postgres and uses own unique
table name instead of default table name</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>std::collections::HashSet;

<span class="kw">use </span>sqlx::{Pool, Postgres};
<span class="kw">use </span>sqlx_migrator::error::Error;
<span class="kw">use </span>sqlx_migrator::migration::{AppliedMigrationSqlRow, Migration};
<span class="kw">use </span>sqlx_migrator::migrator::{DatabaseOperation, Info, Migrate};

<span class="kw">pub struct </span>CustomMigrator {
    migrations: HashSet&lt;Box&lt;<span class="kw">dyn </span>Migration&lt;Postgres&gt;&gt;&gt;,
    pool: Pool&lt;Postgres&gt;,
}

<span class="kw">impl </span>Info&lt;Postgres&gt; <span class="kw">for </span>CustomMigrator {
    <span class="kw">fn </span>migrations(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>HashSet&lt;Box&lt;<span class="kw">dyn </span>Migration&lt;Postgres&gt;&gt;&gt; {
        <span class="kw-2">&amp;</span><span class="self">self</span>.migrations
    }

    <span class="kw">fn </span>migrations_mut(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;mut </span>HashSet&lt;Box&lt;<span class="kw">dyn </span>Migration&lt;Postgres&gt;&gt;&gt; {
        <span class="kw-2">&amp;mut </span><span class="self">self</span>.migrations
    }

    <span class="kw">fn </span>pool(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>Pool&lt;Postgres&gt; {
        <span class="kw-2">&amp;</span><span class="self">self</span>.pool
    }
}
<span class="attr">#[must_use]
</span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>create_migrator_table_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;CREATE TABLE IF NOT EXISTS _custom_migrator_table_name (
       id INT PRIMARY KEY NOT NULL GENERATED ALWAYS AS IDENTITY,
       app TEXT NOT NULL,
       name TEXT NOT NULL,
       applied_time TIMESTAMPTZ NOT NULL DEFAULT now(),
       UNIQUE (app, name)
   )&quot;
</span>}

<span class="attr">#[must_use]
</span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>drop_table_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;DROP TABLE IF EXISTS _custom_migrator_table_name&quot;
</span>}

<span class="attr">#[must_use]
</span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>fetch_row_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;SELECT id, app, name, applied_time FROM _custom_migrator_table_name&quot;
</span>}

<span class="attr">#[must_use]
</span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>add_migration_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;INSERT INTO _custom_migrator_table_name(app, name) VALUES ($1, $2)&quot;
</span>}

<span class="attr">#[must_use]
</span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>delete_migration_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;DELETE FROM _custom_migrator_table_name WHERE app = $1 AND name = $2&quot;
</span>}

<span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">async fn </span>lock_id(pool: <span class="kw-2">&amp;</span>Pool&lt;Postgres&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;i64, Error&gt; {
    <span class="kw">let </span>(database,): (String,) = sqlx::query_as(<span class="string">&quot;SELECT CURRENT_DATABASE()&quot;</span>)
        .fetch_one(pool)
        .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(i64::from(crc32fast::hash(database.as_bytes())))
}

<span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>lock_database_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;SELECT pg_advisory_lock($1)&quot;
</span>}

<span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>unlock_database_query() -&gt; <span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str {
    <span class="string">&quot;SELECT pg_advisory_unlock($1)&quot;
</span>}

<span class="attr">#[async_trait::async_trait]
</span><span class="kw">impl </span>DatabaseOperation&lt;Postgres&gt; <span class="kw">for </span>CustomMigrator {
    <span class="kw">async fn </span>ensure_migration_table_exists(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
        sqlx::query(create_migrator_table_query())
            .execute(<span class="kw-2">&amp;</span><span class="self">self</span>.pool)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">async fn </span>drop_migration_table_if_exists(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
        sqlx::query(drop_table_query()).execute(<span class="kw-2">&amp;</span><span class="self">self</span>.pool).<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">async fn </span>add_migration_to_db_table(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        migration: <span class="kw-2">&amp;</span>Box&lt;<span class="kw">dyn </span>Migration&lt;Postgres&gt;&gt;,
        connection: <span class="kw-2">&amp;mut </span>&lt;Postgres <span class="kw">as </span>sqlx::Database&gt;::Connection,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
        sqlx::query(add_migration_query())
            .bind(migration.app())
            .bind(migration.name())
            .execute(connection)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">async fn </span>delete_migration_from_db_table(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        migration: <span class="kw-2">&amp;</span>Box&lt;<span class="kw">dyn </span>Migration&lt;Postgres&gt;&gt;,
        connection: <span class="kw-2">&amp;mut </span>&lt;Postgres <span class="kw">as </span>sqlx::Database&gt;::Connection,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
        sqlx::query(delete_migration_query())
            .bind(migration.app())
            .bind(migration.name())
            .execute(connection)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">async fn </span>fetch_applied_migration_from_db(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;AppliedMigrationSqlRow&gt;, Error&gt; {
        <span class="kw">let </span>rows = sqlx::query_as(fetch_row_query())
            .fetch_all(<span class="kw-2">&amp;</span><span class="self">self</span>.pool)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(rows)
    }

    <span class="kw">async fn </span>lock(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        connection: <span class="kw-2">&amp;mut </span>&lt;Postgres <span class="kw">as </span>sqlx::Database&gt;::Connection,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
        <span class="kw">let </span>lock_id = lock_id(<span class="kw-2">&amp;</span><span class="self">self</span>.pool).<span class="kw">await</span><span class="question-mark">?</span>;
        sqlx::query(lock_database_query())
            .bind(lock_id)
            .execute(connection)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">async fn </span>unlock(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        connection: <span class="kw-2">&amp;mut </span>&lt;Postgres <span class="kw">as </span>sqlx::Database&gt;::Connection,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
        <span class="kw">let </span>lock_id = lock_id(<span class="kw-2">&amp;</span><span class="self">self</span>.pool).<span class="kw">await</span><span class="question-mark">?</span>;
        sqlx::query(unlock_database_query())
            .bind(lock_id)
            .execute(connection)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }
}

<span class="kw">impl </span>Migrate&lt;Postgres&gt; <span class="kw">for </span>CustomMigrator {}</code></pre></div>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.Migrator.html" title="struct sqlx_migrator::migrator::Migrator">Migrator</a></div><div class="desc docblock-short">Migrator struct which store migrations graph and information related to
different library supported migrations</div></li><li><div class="item-name"><a class="struct" href="struct.Plan.html" title="struct sqlx_migrator::migrator::Plan">Plan</a></div><div class="desc docblock-short">Struct which determine type of plan to use</div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.PlanType.html" title="enum sqlx_migrator::migrator::PlanType">PlanType</a></div><div class="desc docblock-short">Type of plan which needs to be generate</div></li></ul><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.DatabaseOperation.html" title="trait sqlx_migrator::migrator::DatabaseOperation">DatabaseOperation</a></div><div class="desc docblock-short">Trait which is implemented for database for performing database related
actions on database. Usually this trait is implemented for database to
support certain database along with info trait</div></li><li><div class="item-name"><a class="trait" href="trait.Info.html" title="trait sqlx_migrator::migrator::Info">Info</a></div><div class="desc docblock-short">Info trait which implements some of database agnostic methods to
return data. Only required methods needs to be implemented if you want to
create your own migrator struct. This trait implements methods which doesn’t
depends on Database Operation trait methods</div></li><li><div class="item-name"><a class="trait" href="trait.Migrate.html" title="trait sqlx_migrator::migrator::Migrate">Migrate</a></div><div class="desc docblock-short">Migrate trait which migrate a database according to requirements. This trait
implements all methods which depends on DatabaseOperation trait. This trait
is not required to implement any method since all have provided
implementation and good to go for database agnostic case</div></li></ul></section></div></main></body></html>